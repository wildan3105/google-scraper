#!/usr/bin/env node

import fs from 'fs';
import readline from 'readline';
import { $Refs } from 'swagger-parser';

// https://github.com/APIDevTools/json-schema-ref-parser/issues/139
import $RefParser from '@apidevtools/json-schema-ref-parser';
$RefParser.dereference = $RefParser.dereference.bind($RefParser);
$RefParser.resolve = $RefParser.resolve.bind($RefParser);

const schemaHttpCode = require('./schema-http-code.json'); // eslint-disable-line @typescript-eslint/no-var-requires

function logUsageHelp() {
    // eslint-disable-next-line no-console
    console.log(
        `

usage:
  ./generate-error-map <command>

  commands can be:
    generate: generate map file, will prompt user for output file location
    help: print usage guide
`
    );
}

function readOutFilePath(): Promise<string> {
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });

    return new Promise((resolve) => {
        rl.question('Output file location (./src/generated/error-codes.ts): ', (answer) => {
            if (!answer) {
                resolve('./src/generated/error-codes.ts');
            }
            resolve(answer);
        });
    });
}

function generateErrorCodes(openapiDoc: $Refs): string {
    const errorCodes = new Array<string>();
    Object.keys(schemaHttpCode).forEach((schemaName) => {
        const codes = openapiDoc.get(
            // '/' in node names needs to be escaped as '~1' when used in a $ref
            `#/components/schemas/${schemaName}/properties/error_code/enum`
        );
        errorCodes.push(...codes);
    });
    return `export const ErrorCodes = {\n${errorCodes.reduce(
        (contentStr, schemaName) => `${contentStr}    ${schemaName}: '${schemaName}',\n`,
        ''
    )}};\n`;
}

function generateErrorCodeHttpMap(openapiDoc: $Refs): string {
    let contentStr = 'export const ErrorCodeMap: { [key: string]: number } = {\n';
    Object.keys(schemaHttpCode).forEach((schemaName) => {
        openapiDoc
            .get(
                // '/' in node names needs to be escaped as '~1' when used in a $ref
                `#/components/schemas/${schemaName}/properties/error_code/enum`
            )
            .forEach((code: string) => {
                contentStr += `    ${code}: ${schemaHttpCode[schemaName]},\n`;
            });
    });
    contentStr += '};\n';
    return contentStr;
}

function generateFileContent(): Promise<string> {
    return $RefParser.resolve('./docs/openapi.yaml').then((openapiDoc) => {
        let content = `// This file was generated by src/cmd/generate-error-map
// based on docs/openapi.yaml & src/cmd/generate-error-map/schema-http-code.json.
// Please DON'T change this file directly!!!
// Apply your changes in docs/openapi.yaml & src/cmd/generate-error-map/schema-http-code.json
// and run \`npm run generate-error-map\` instead.\n`;
        content += generateErrorCodes(openapiDoc as any); // eslint-disable-line
        content += generateErrorCodeHttpMap(openapiDoc as any); // eslint-disable-line
        return content;
    });
}

function generateFile() {
    return Promise.all([readOutFilePath(), generateFileContent()]).then(([filepath, content]) => {
        fs.writeFileSync(filepath, content);
        console.log(`Successfully generated error files at ${filepath}`); // Log the full path
    });
}


const args = process.argv;
switch (args[2]) {
    case 'generate':
        generateFile()
            .then(() => {
                process.exit(0);
            })
            .catch((err) => {
                console.error(err); // eslint-disable-line no-console
                process.exit(1);
            });
        break;
    case 'help':
    default:
        logUsageHelp();
}
